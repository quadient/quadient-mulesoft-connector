var WebVTTParser=function(){this.parse=function(e,r){function m(n,h){d.push({message:n,line:c+1,col:h})}var q=Date.now(),c=0;e=e.split(/\r\n|\r|\n/);var l=!1,k=[],d=[],a=e[c],f=a.length,b=0,g=6;"\ufeff"===a[0]&&(b=1,g+=1);(f<g||a.indexOf("WEBVTT")!==0+b||f>g&&" "!==a[g]&&"\t"!==a[g])&&m('No valid signature. (File needs to start with "WEBVTT".)');for(c++;""!=e[c]&&void 0!=e[c];){m("No blank line after the signature.");if(-1!=e[c].indexOf("--\x3e")){l=!0;break}c++}for(;void 0!=e[c];){for(;!l&&""==e[c];)c++;
if(!l&&void 0==e[c])break;a={id:"",startTime:0,endTime:0,pauseOnExit:!1,direction:"horizontal",snapToLines:!0,linePosition:"auto",textPosition:50,size:100,alignment:"middle",text:"",tree:null};f=!0;if(-1==e[c].indexOf("--\x3e")){a.id=e[c];if(/^NOTE($|[ \t])/.test(a.id)){for(c++;""!=e[c]&&void 0!=e[c];)-1!=e[c].indexOf("--\x3e")&&m("Cannot have timestamp in a comment."),c++;continue}c++;if(""==e[c]||void 0==e[c]){m("Cue identifier cannot be standalone.");continue}-1==e[c].indexOf("--\x3e")&&(f=!1,
m("Cue identifier needs to be followed by timestamp."))}l=!1;b=new WebVTTCueTimingsAndSettingsParser(e[c],m);g=0;0<k.length&&(g=k[k.length-1].startTime);if(f&&!b.parse(a,g))for(a=null,c++;""!=e[c]&&void 0!=e[c];){if(-1!=e[c].indexOf("--\x3e")){l=!0;break}c++}else{for(c++;""!=e[c]&&void 0!=e[c];){if(-1!=e[c].indexOf("--\x3e")){m("Blank line missing before cue.");l=!0;break}""!=a.text&&(a.text+="\n");a.text+=e[c];c++}f=new WebVTTCueTextParser(a.text,m,r);a.tree=f.parse(a.startTime,a.endTime);k.push(a)}}k.sort(function(n,
h){return n.startTime<h.startTime?-1:n.startTime>h.startTime?1:n.endTime>h.endTime?-1:n.endTime<h.endTime?1:0});return{cues:k,errors:d,time:Date.now()-q}}},WebVTTCueTimingsAndSettingsParser=function(e,r){function m(f){for(;void 0!=e[d]&&f.test(e[d]);)d++}function q(f){for(var b="";void 0!=e[d]&&f.test(e[d]);)b+=e[d],d++;return b}function c(){var f="minutes";if(void 0==e[d])a("No timestamp found.");else if(/\d/.test(e[d])){var b=q(/\d/);if(2<b.length||59<parseInt(b,10))f="hours";if(":"!=e[d])a("No time unit separator found.");
else{d++;var g=q(/\d/);if(2!=g.length)a("Must be exactly two digits.");else{if("hours"==f||":"==e[d]){if(":"!=e[d]){a("No seconds found or minutes is greater than 59.");return}d++;f=q(/\d/);if(2!=f.length){a("Must be exactly two digits.");return}}else f=g,g=b,b="0";if("."!=e[d])a('No decimal separator (".") found.');else{d++;var n=q(/\d/);if(3!=n.length)a("Milliseconds must be given in three digits.");else if(59<parseInt(g,10))a("You cannot have more than 59 minutes.");else if(59<parseInt(f,10))a("You cannot have more than 59 seconds.");
else return 3600*parseInt(b,10)+60*parseInt(g,10)+parseInt(f,10)+parseInt(n,10)/1E3}}}}else a("Timestamp must start with a character in the range 0-9.")}var l=/[\u0020\t\f]/,k=/[^\u0020\t\f]/,d=0,a=function(f){r(f,d+1)};this.parse=function(f,b){m(l);f.startTime=c();if(void 0!=f.startTime)if(f.startTime<b&&a("Start timestamp is not greater than or equal to start timestamp of previous cue."),k.test(e[d])&&a("Timestamp not separated from '--\x3e' by whitespace."),m(l),"-"!=e[d])a("No valid timestamp separator found.");
else if(d++,"-"!=e[d])a("No valid timestamp separator found.");else if(d++,">"!=e[d])a("No valid timestamp separator found.");else if(d++,k.test(e[d])&&a("'--\x3e' not separated from timestamp by whitespace."),m(l),f.endTime=c(),void 0!=f.endTime){f.endTime<=f.startTime&&a("End timestamp is not greater than start timestamp.");k.test(e[d]);m(l);a:{b=e.substring(d).split(l);for(var g=[],n=0;n<b.length;n++)if(""!=b[n]){var h=b[n].indexOf(":"),p=b[n].slice(0,h);value=b[n].slice(h+1);-1!=g.indexOf(p)&&
a("Duplicate setting.");g.push(p);if(""==value){a("No value for setting defined.");break a}if("vertical"==p)"rl"!=value&&"lr"!=value?a("Writing direction can only be set to 'rl' or 'rl'."):f.direction=value;else if("line"==p)if(/\d/.test(value))if(-1!=value.indexOf("-",1))a("Line position can only have '-' at the start.");else if(-1!=value.indexOf("%")&&value.indexOf("%")!=value.length-1)a("Line position can only have '%' at the end.");else if("-"==value[0]&&"%"==value[value.length-1])a("Line position cannot be a negative percentage.");
else{if("%"==value[value.length-1]){if(100<parseInt(value,10)){a("Line position cannot be >100%.");continue}f.snapToLines=!1}f.linePosition=parseInt(value,10)}else a("Line position takes a number or percentage.");else"position"==p?"%"!=value[value.length-1]?a("Text position must be a percentage."):100<parseInt(value,10)?a("Size cannot be >100%."):f.textPosition=parseInt(value,10):"size"==p?"%"!=value[value.length-1]?a("Size must be a percentage."):100<parseInt(value,10)?a("Size cannot be >100%."):
f.size=parseInt(value,10):"align"==p?(h=["start","middle","end","left","right"],-1==h.indexOf(value)?a("Alignment can only be set to one of "+h.join(", ")+"."):f.alignment=value):a("Invalid setting.")}}return!0}};this.parseTimestamp=function(){var f=c();if(void 0!=e[d])a("Timestamp must not have trailing characters.");else return f}},WebVTTCueTextParser=function(e,r,m){function q(){for(var k="data",d="",a="",f=[];void 0!=e[c-1]||0==c;){var b=e[c];if("data"==k)if("&"==b)a=b,k="escape";else if("<"==
b&&""==d)k="tag";else{if("<"==b||void 0==b)return["text",d];d+=b}else if("escape"==k)if("&"==b)l("Incorrect escape."),d+=a,a=b;else if(/[abglmnsprt]/.test(b))a+=b;else{if(";"==b)"&amp"==a?d+="&":"&lt"==a?d+="<":"&gt"==a?d+=">":"&lrm"==a?d+="\u200e":"&rlm"==a?d+="\u200f":"&nbsp"==a?d+="\u00a0":(l("Incorrect escape."),d+=a+";");else{if("<"==b||void 0==b)return l("Incorrect escape."),d+=a,["text",d];l("Incorrect escape.");d+=a+b}k="data"}else if("tag"==k)if("\t"==b||"\n"==b||"\f"==b||" "==b)k="start tag annotation";
else if("."==b)k="start tag class";else if("/"==b)k="end tag";else if(/\d/.test(b))d=b,k="timestamp tag";else{if(">"==b||void 0==b)return">"==b&&c++,["start tag","",[],""];d=b;k="start tag"}else if("start tag"==k)if("\t"==b||"\f"==b||" "==b)k="start tag annotation";else if("\n"==b)a=b,k="start tag annotation";else if("."==b)k="start tag class";else{if(">"==b||void 0==b)return">"==b&&c++,["start tag",d,[],""];d+=b}else if("start tag class"==k)if("\t"==b||"\f"==b||" "==b)f.push(a),a="",k="start tag annotation";
else if("\n"==b)f.push(a),a=b,k="start tag annotation";else if("."==b)f.push(a),a="";else{if(">"==b||void 0==b)return">"==b&&c++,f.push(a),["start tag",d,f,""];a+=b}else if("start tag annotation"==k){if(">"==b||void 0==b)return">"==b&&c++,a=a.split(/[\u0020\t\f\r\n]+/).filter(function(g){if(g)return!0}).join(" "),["start tag",d,f,a];a+=b}else if("end tag"==k){if(">"==b||void 0==b)return">"==b&&c++,["end tag",d];d+=b}else if("timestamp tag"==k){if(">"==b||void 0==b)return">"==b&&c++,["timestamp",d];
d+=b}else l("Never happens.");c++}}var c=0,l=function(k){"metadata"!=m&&r(k,c+1)};this.parse=function(k,d){function a(t){g.children.push({type:"object",name:t[1],classes:t[2],children:[],parent:g});g=g.children[g.children.length-1]}function f(t){for(var u=g;u;){if(u.name==t)return!0;u=u.parent}}for(var b={children:[]},g=b,n=[];void 0!=e[c];){var h=q();if("text"==h[0])g.children.push({type:"text",value:h[1],parent:g});else if("start tag"==h[0]){"chapters"==m&&l("Start tags not allowed in chapter title text.");
var p=h[1];"v"!=p&&"lang"!=p&&""!=h[3]&&l("Only <v> and <lang> can have an annotation.");"c"==p||"i"==p||"b"==p||"u"==p||"ruby"==p?a(h):"rt"==p&&"ruby"==g.name?a(h):"v"==p?(f("v")&&l("<v> cannot be nested inside itself."),a(h),g.value=h[3],h[3]||l("<v> requires an annotation.")):"lang"==p?(a(h),g.value=h[3]):l("Incorrect start tag.")}else"end tag"==h[0]?("chapters"==m&&l("End tags not allowed in chapter title text."),h[1]==g.name?g=g.parent:"ruby"==h[1]&&"rt"==g.name?g=g.parent.parent:l("Incorrect end tag.")):
"timestamp"==h[0]&&("chapters"==m&&l("Timestamp not allowed in chapter title text."),h=(new WebVTTCueTimingsAndSettingsParser(h[1],l)).parseTimestamp(),void 0!=h&&((h<=k||h>=d)&&l("Timestamp must be between start timestamp and end timestamp."),0<n.length&&n[n.length-1]>=h&&l("Timestamp must be greater than any previous timestamp."),g.children.push({type:"timestamp",value:h,parent:g}),n.push(h)))}for(;g.parent;)"v"!=g.name&&l("Required end tag missing."),g=g.parent;return b}},WebVTTSerializer=function(){function e(r){for(var m=
"",q=0;q<r.length;q++){var c=r[q];if("text"==c.type)m+=c.value;else if("object"==c.type){m+="<"+c.name;if(c.classes)for(var l=0;l<c.classes.length;l++)m+="."+c.classes[l];c.value&&(m+=" "+c.value);m+=">";c.children&&(m+=e(c.children));m+="</"+c.name+">"}else m+="<"+c.value+">"}return m}this.serialize=function(r){for(var m="",q=0;q<r.length;q++){var c=r[q];c=c.startTime+" "+c.endTime+"\n"+e(c.tree.children)+"\n\n";m+=c}return m}};
